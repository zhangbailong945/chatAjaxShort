<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
<title>聊天室</title>
<link rel="stylesheet" type="text/css" href="css/chat.css" />
<link rel="stylesheet" type="text/css" href="./plugins/layui/css/layui.css" />


<!--[if lt IE 7]>
<script src="js/IE7.js" type="text/javascript"></script>
<![endif]-->
<!--[if IE 6]>
<script src="js/iepng.js" type="text/javascript"></script>
<script type="text/javascript">
EvPNG.fix('body, div, ul, img, li, input, a, span ,label'); 
</script>
<![endif]-->
</head>
<body class="keBody" onbeforeunload="return userExit()" >
<h1 class="keTitle">短轮询聊天室</h1>
<div class="kePublic">
<!--效果html开始-->
    <div class="content">
        <div class="chatBox">
            <div class="chatLeft">
                <div class="chat01">
                    <div class="chat01_title">
                        <ul class="talkTo">
                            <li><a href="javascript:;">群聊</a></li></ul>
                        <a class="close_btn" href="javascript:;"></a>
                    </div>
                    <div class="chat01_content">
                        <div class="message_box mes1">
                        </div>
                        <div class="message_box mes2">
                        </div>
                        <div class="message_box mes3" style="display: block;">
                        </div>
                        <div class="message_box mes4">
                        </div>
                        <div class="message_box mes5">
                        </div>
                        <div class="message_box mes6">
                        </div>
                        <div class="message_box mes7">
                        </div>
                        <div class="message_box mes8">
                        </div>
                        <div class="message_box mes9">
                        </div>
                        <div class="message_box mes10">
                        </div>
                    </div>
                </div>
                <div class="chat02">
                    <div class="chat02_title">
                        <a class="chat02_title_btn ctb01" href="javascript:;"></a><a class="chat02_title_btn ctb02"
                            href="javascript:;" title="选择文件">
                            <embed width="15" height="16" flashvars="swfid=2556975203&amp;maxSumSize=50&amp;maxFileSize=50&amp;maxFileNum=1&amp;multiSelect=0&amp;uploadAPI=http%3A%2F%2Fupload.api.weibo.com%2F2%2Fmss%2Fupload.json%3Fsource%3D209678993%26tuid%3D1887188824&amp;initFun=STK.webim.ui.chatWindow.msgToolBar.upload.initFun&amp;sucFun=STK.webim.ui.chatWindow.msgToolBar.upload.sucFun&amp;errFun=STK.webim.ui.chatWindow.msgToolBar.upload.errFun&amp;beginFun=STK.webim.ui.chatWindow.msgToolBar.upload.beginFun&amp;showTipFun=STK.webim.ui.chatWindow.msgToolBar.upload.showTipFun&amp;hiddenTipFun=STK.webim.ui.chatWindow.msgToolBar.upload.hiddenTipFun&amp;areaInfo=0-16|12-16&amp;fExt=*.jpg;*.gif;*.jpeg;*.png|*&amp;fExtDec=选择图片|选择文件"
                                data="upload.swf" wmode="transparent" bgcolor="" allowscriptaccess="always" allowfullscreen="true"
                                scale="noScale" menu="false" type="application/x-shockwave-flash" src="http://service.weibo.com/staticjs/tools/upload.swf?v=36c9997f1313d1c4"
                                id="swf_3140">
                        </a><a class="chat02_title_btn ctb03" href="javascript:;" title="选择附件">
                            <embed width="15" height="16" flashvars="swfid=2556975203&amp;maxSumSize=50&amp;maxFileSize=50&amp;maxFileNum=1&amp;multiSelect=0&amp;uploadAPI=http%3A%2F%2Fupload.api.weibo.com%2F2%2Fmss%2Fupload.json%3Fsource%3D209678993%26tuid%3D1887188824&amp;initFun=STK.webim.ui.chatWindow.msgToolBar.upload.initFun&amp;sucFun=STK.webim.ui.chatWindow.msgToolBar.upload.sucFun&amp;errFun=STK.webim.ui.chatWindow.msgToolBar.upload.errFun&amp;beginFun=STK.webim.ui.chatWindow.msgToolBar.upload.beginFun&amp;showTipFun=STK.webim.ui.chatWindow.msgToolBar.upload.showTipFun&amp;hiddenTipFun=STK.webim.ui.chatWindow.msgToolBar.upload.hiddenTipFun&amp;areaInfo=0-16|12-16&amp;fExt=*.jpg;*.gif;*.jpeg;*.png|*&amp;fExtDec=选择图片|选择文件"
                                data="upload.swf" wmode="transparent" bgcolor="" allowscriptaccess="always" allowfullscreen="true"
                                scale="noScale" menu="false" type="application/x-shockwave-flash" src="http://service.weibo.com/staticjs/tools/upload.swf?v=36c9997f1313d1c4"
                                id="swf_3140">
                        </a>
                        <label class="chat02_title_t">
                            <a href="chat.htm" target="_blank">聊天记录</a></label>
                        <div class="wl_faces_box">
                            <div class="wl_faces_content">
                                <div class="title">
                                    <ul>
                                        <li class="title_name">常用表情</li><li class="wl_faces_close"><span>&nbsp;</span></li></ul>
                                </div>
                                <div class="wl_faces_main">
                                    <ul>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_01.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_02.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_03.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_04.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_05.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_06.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_07.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_08.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_09.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_10.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_11.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_12.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_13.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_14.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_15.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_16.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_17.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_18.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_19.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_20.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_21.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_22.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_23.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_24.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_25.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_26.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_27.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_28.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_29.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_30.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_31.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_32.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_33.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_34.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_35.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_36.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_37.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_38.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_39.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_40.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_41.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_42.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_43.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_44.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_45.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_46.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_47.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_48.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_49.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_50.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_51.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_52.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_53.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_54.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_55.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_56.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_57.gif" /></a></li>
                                        <li><a href="javascript:;">
                                            <img src="img/emo_58.gif" /></a></li><li><a href="javascript:;">
                                                <img src="img/emo_59.gif" /></a></li><li><a href="javascript:;">
                                                    <img src="img/emo_60.gif" /></a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="wlf_icon">
                            </div>
                        </div>
                    </div>
                    <div class="chat02_content">
                        <textarea id="textarea"></textarea>
                    </div>
                    <div class="chat02_bar">
                        <ul>
                            <li style="left: 20px; top: 10px; padding-left: 30px;"><a href="#" id="current" target="_blank"></a></li>
                            <li style="right: 5px; top: 5px;"><a href="javascript:;">
                                <img id="send" src="img/send_btn.jpg"></a>
                                <a><img id="quit" src="img/exit_btn.jpg"></a>
                                </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="chatRight">
                <div class="chat03">
                    <input type="hidden" value="" id="sid" />
                    <div class="chat03_title">
                        <label class="chat03_title_t">
                            成员列表</label>
                    </div>
                    <div class="chat03_content">
                        <ul id="online_person">
                            <!--  
                            <li>
                                <label class="online">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2013.jpg"></a><a href="javascript:;" class="chat03_name">刘秀</a>
                            </li>
                            <li>
                                <label class="offline">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2014.jpg"></a><a href="javascript:;" class="chat03_name">陈诚</a>
                            </li>
                            <li class="choosed">
                                <label class="offline">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2015.jpg"></a><a href="javascript:;" class="chat03_name">王旭</a>
                            </li>
                            <li>
                                <label class="offline">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2016.jpg"></a><a href="javascript:;" class="chat03_name">张灵</a>
                            </li>
                            <li>
                                <label class="online">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2017.jpg"></a><a href="javascript:;" class="chat03_name">吴敬</a>
                            </li>
                            <li>
                                <label class="offline">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2018.jpg"></a><a href="javascript:;" class="chat03_name">王海东</a>
                            </li>
                            <li>
                                <label class="offline">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2019.jpg"></a><a href="javascript:;" class="chat03_name">郑小勇</a>
                            </li>
                            <li>
                                <label class="online">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2020.jpg"></a><a href="javascript:;" class="chat03_name">张珊珊</a>
                            </li>
                            <li>
                                <label class="offline">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2021.jpg"></a><a href="javascript:;" class="chat03_name">刘强</a>
                            </li>
                            <li>
                                <label class="offline">
                                </label>
                                <a href="javascript:;">
                                    <img src="img/head/2022.jpg"></a><a href="javascript:;" class="chat03_name">程海斌</a>
                            </li>
                            -->
                        </ul>
                    </div>
                </div>
            </div>
            <div style="clear: both;">
            </div>
        </div>
    </div>
<!--效果html结束-->
</div>
<div class="keBottom">
</div>
<script type="text/javascript" src="./js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="./plugins/layer/layer.js"></script>
<script type="text/javascript" src="./plugins/layui/layui.js"></script>
<script type="text/javascript">
$(function(){

	checkUser();
    //短轮询
    setInterval("getCurrentUser()",3000);
	setInterval("getList()",3000);
	setInterval("showMessage()",3000);
	//短轮询
    //发送按钮事件
	$('#send').on('click',sendMessage);
	$('#quit').on('click',userExit);

	$(document).keydown(function(event){
	    
	    //屏蔽 Alt+ 方向键 ← 
	    //屏蔽 Alt+ 方向键 →
	    if ((event.altKey)&&((event.keyCode==37)||(event.keyCode==39)))  
	    { 
	       event.returnValue=false; 
	       return false;
	    }

	    if((event.altKey)&&(event.keyCode==115))  
	    { 
	       return false;
	    }
	        
	    //屏蔽F5刷新键 
	    if(event.keyCode==116){
	       return false; 
	    }
	 
	   //屏蔽alt+R 
	   if((event.ctrlKey) && (event.keyCode==82)){
	      return false; 
	   }

	});

	
});

//是否有昵称
function inputNickName()
{

		//访问主页，提示客户输入用户名
		layui.use(['layer', 'form'], function(){
	
				layer.prompt({
				  formType: 0,
				  title: '请输入昵称!'
				}, function(value, index, elem){
				  var nickname=value;
				  $.ajax({
			         url:'./lib/ChatServer1.php',
			         type:'POST',
			         data:{'action':'addchat','nickname':value},
			         dataType:'json',
			         success:function(result)
			         {
			             if(result.status)
			             {
			                 layer.msg(result.message);
			                 $('#current').html(result.data.nickname);
			                 $('#sid').val(result.data.id);
			                 layer.close(index);
			             }else
			             {
			            	 layer.msg(result.message);
			             }
			         },
			         error:function(xhr)
			         {
			              layer.msg("错误提示:"+xhr.status+"->"+xhr.statusText);
			         }
			         
			      });
				  
				});
		});

}


//获取在线用户
function getList()
{
	$.ajax({
        url:'./lib/ChatServer1.php',
        type:'POST',
        data:{'action':'list'},
        dataType:'json',
        success:function(result)
        {
            if(result.status)
            {   
                var html='';
                $.each(result.chatlist,function(k,v){
                     html+="<li><label class='online'></label><a href='javascript:;'><img src='."+v.headimg+"'></a><a href='javascript:;' class='chat03_name'>"+v.nickname+"</a></li>";
                });
                $('#online_person').html(html);
                
            }else
            {
           	   //layer.msg('无法获取列表!1');
            }
        },
        error:function(xhr)
        {
             //layer.msg("错误提示:"+xhr.status+"->"+xhr.statusText);
        }
        
     });
}

//设置最新内容一致在底部
function setHeight()
{
   $('.chat01_content').scrollTop($('.chat01_content')[0].scrollHeight);  
}





//获取消息列表
function showMessage()
{
	$.ajax({
        url:'./lib/ChatServer1.php',
        type:'POST',
        data:{'action':'message'},
        dataType:'json',
        success:function(result)
        {
            if(result.status)
            {   
                var html='';
                $.each(result.msglist,function(k,v){
                     html+='<div class="message clearfix"><div class="user-logo"><img src=".'+v.simg+'"></div><div class="wrap-text"><h5 class="clearfix">'+v.sname+'</h5><div>'+v.content+'</div></div><div class="wrap-ri"><div clsss="clearfix"><span>'+v.addtime+'</span></div></div><div style="clear:both;"></div></div>';
                });
                $('.mes3').html(html);
                setHeight();
            }else
            {
           	 layer.msg('无法获取列表!');
            }
        },
        error:function(xhr)
        {
             //layer.msg("错误提示:"+xhr.status+"->"+xhr.statusText);
        }
        
     });
}

//发送消息
function sendMessage()
{
   var content=$('#textarea').val(); //内容
   var sid=$('#sid').val(); //发送者
   var rid=3; //群聊
   if(sid!=0)
   {
	   if(content.length>0)
	   {
		   $.ajax({
		        url:'./lib/ChatServer1.php',
		        type:'POST',
		        data:{'action':'allchat','sid':sid,'rid':rid,'content':content},
		        dataType:'json',
		        success:function(result)
		        {
		            if(result.status)
		            {   
		            	$('#textarea').val("");	            	
			            showMessage();
		                setHeight();
		            }else
		            {
		           	   layer.msg(result.message);
		            }
		        },
		        error:function(xhr)
		        {
		             //layer.msg("错误提示:"+xhr.status+"->"+xhr.statusText);
		        }
		        
		     });
	   }
	   else
	   {
		   layer.msg('请输入聊天内容!');
	   }
   }
   else
   {
       inputNickName();
   }
}

//获取当前用户
function checkUser()
{

	$.ajax({
        url:'./lib/ChatServer1.php',
        type:'POST',
        data:{'action':'user'},
        dataType:'json',
        success:function(result)
        {
            if(result.status)
            {   
                                 
            }
            else
            {
            	inputNickName();
            }
        },
        error:function(xhr)
        {
        	inputNickName();
        }
        
     }); 
}

//获取当前用户
function getCurrentUser()
{
	
	$.ajax({
        url:'./lib/ChatServer1.php',
        type:'POST',
        data:{'action':'user'},
        dataType:'json',
        success:function(result)
        {
            if(result.status)
            {   
                var html='';
                $('#current').html('<font color="blue">我('+result.data.nickname+')</font>,<font color="green">在线</font>.');
                $('#sid').val(result.data.id);             
            }
        },
        error:function(xhr)
        {
             //layer.msg("错误提示:"+xhr.status+"->"+xhr.statusText);
        }
        
     });
}

function userExit()
{
	$.ajax({
        url:'./lib/ChatServer1.php',
        type:'POST',
        data:{'action':'exit'},
        dataType:'json',
        async:false,
        success:function(result)
        {
            if(result.status)
            {   

            	console.log(result.status);  
            	location.href="";
            }
            else
            {
            	console.log(result.status);
            	location.href="";
            }
        },
        error:function(xhr)
        {
        	console.log(xhr.status);
             //layer.msg("错误提示:"+xhr.status+"->"+xhr.statusText);
        }
        
     });
    
}







</script>

</body>
</html>